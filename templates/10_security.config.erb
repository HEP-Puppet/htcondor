# HTCondor configuration: security

<% if @default_domain_name -%>
DEFAULT_DOMAIN_NAME = <%= @default_domain_name %>
<% end -%>
UID_DOMAIN = <%= @uid_domain %>
<% if @filesystem_domain -%>
FILESYSTEM_DOMAIN = <%= @filesystem_domain %>
<% end -%>

COLLECTOR_HOST = <%= @managers.flatten.join(', ') %>

<% if @cluster_has_multiple_domains == true then -%>
TRUST_UID_DOMAIN = True
<% end -%>

# Machines & users
CMS = <%= @managers.flatten.join(', ') %>
CES = <%= @computing_elements.flatten.join(', ') %>
WNS = <%= @worker_nodes.flatten.join(', ') %>

USERS = *@$(UID_DOMAIN)

# Clear out any old-style HOSTALLOW settings:
HOSTALLOW_READ =
HOSTALLOW_WRITE =
HOSTALLOW_DAEMON =
HOSTALLOW_NEGOTIATOR =
HOSTALLOW_ADMINISTRATOR =
HOSTALLOW_OWNER =
HOSTALLOW_NEGOTIATOR = $(COLLECTOR_HOST)
HOSTALLOW_ADMINISTRATOR = $(COLLECTOR_HOST)
HOSTALLOW_NEGOTIATOR_SCHEDD = $(COLLECTOR_HOST)

ALLOW_READ = */*.$(UID_DOMAIN)
ALLOW_WRITE = $(CMS), $(CES), $(WNS)

#if the CE has a private NIC, it needs to be included here as well
COLLECTOR.ALLOW_ADVERTISE_MASTER = $(CES), $(CMS), $(WNS)
COLLECTOR.ALLOW_ADVERTISE_SCHEDD = $(CES)
COLLECTOR.ALLOW_ADVERTISE_STARTD = $(WNS)

SCHEDD.ALLOW_WRITE = $(USERS), $(CES)

#SHADOW.ALLOW_WRITE = $(WNS), $(CES)

ALLOW_DAEMON = <%= @condor_user %>@$(UID_DOMAIN)/*.$(UID_DOMAIN), condor_pool@$(UID_DOMAIN)/*.$(UID_DOMAIN)
<% if @condor_user == 'root' and @condor_group == 'root' -%>
ALLOW_ADMINISTRATOR = root@$(UID_DOMAIN)/$(FULL_HOSTNAME)
<% else -%>
ALLOW_ADMINISTRATOR = root@$(UID_DOMAIN)/$(FULL_HOSTNAME), <%= @condor_user %>@$(UID_DOMAIN)/$(FULL_HOSTNAME)
<% end -%>
ALLOW_CONFIG = root@$(FULL_HOSTNAME)

# Don't allow nobody to run jobs
SCHEDD.DENY_WRITE = nobody@$(UID_DOMAIN)
# Authentication defaults
SEC_DEFAULT_AUTHENTICATION = REQUIRED
SEC_DEFAULT_AUTHENTICATION_METHODS =
SEC_CLIENT_AUTHENTICATION = REQUIRED
SEC_CLIENT_AUTHENTICATION_METHODS =
SEC_READ_AUTHENTICATION = OPTIONAL
SEC_ENABLE_MATCH_PASSWORD_AUTHENTICATION = True
# Integrity
SEC_DEFAULT_INTEGRITY  = REQUIRED
SEC_DAEMON_INTEGRITY = REQUIRED
SEC_NEGOTIATOR_INTEGRITY = REQUIRED
# Encryption
SEC_DEFAULT_ENCRYPTION = REQUIRED
SEC_DEFAULT_CRYPTO_METHODS = BLOWFISH

# Authentication details
<% if @use_claim_to_be_security then -%>
SEC_DEFAULT_AUTHENTICATION_METHODS = $(SEC_DEFAULT_AUTHENTICATION_METHODS),CLAIMTOBE
SEC_CLIENT_AUTHENTICATION_METHODS = $(SEC_CLIENT_AUTHENTICATION_METHODS),CLAIMTOBE
<% end -%>
<% if @use_filesystem_security then -%>
SEC_DEFAULT_AUTHENTICATION_METHODS = $(SEC_DEFAULT_AUTHENTICATION_METHODS),FS
SEC_CLIENT_AUTHENTICATION_METHODS = $(SEC_CLIENT_AUTHENTICATION_METHODS),FS
<% end -%>
<% if @use_kerberos_security then -%>
SEC_DEFAULT_AUTHENTICATION_METHODS = $(SEC_DEFAULT_AUTHENTICATION_METHODS),KERBEROS
SEC_CLIENT_AUTHENTICATION_METHODS = $(SEC_CLIENT_AUTHENTICATION_METHODS),KERBEROS
CERTIFICATE_MAPFILE = /etc/condor/certificate_mapfile
<% end -%>
<% if @use_password_security then -%>
SEC_DEFAULT_AUTHENTICATION_METHODS = $(SEC_DEFAULT_AUTHENTICATION_METHODS),PASSWORD
SEC_CLIENT_AUTHENTICATION_METHODS = $(SEC_CLIENT_AUTHENTICATION_METHODS),PASSWORD
SEC_PASSWORD_FILE = /etc/condor/pool_password
<% end -%>
